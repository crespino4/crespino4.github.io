<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Interaction Widget</title>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>

    <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="//sdk-cdn.mypurecloud.com/client-apps/1.3.0/purecloud-client-app-sdk.js"></script>

</head>
<body>
	<h1 id="title" width="100%" align="center">Interaction App</h1>
	<h2 id="welcome" width="100%" align="center">Welcome</h2>
	<h2 id="conversation" width="100%" align="center">Conversation:</h2>
	<script>
	
	function parseAppParameters(queryString) {
	    console.log("Interaction App Query String: " + queryString);

		let appParams = {
							pcEnv: null,
							langTag: null,
							pcConversationId: null
						};

	    
	    if ( queryString.length != 0 ) {
			const pairs = queryString.split('&');
		
			for (var i = 0; i < pairs.length; i++)
			{
				var currParam = pairs[i].split('=');

				if(currParam[0] === 'pcLangTag') {
					appParams.langTag = currParam[1];
				} else if(currParam[0] === 'pcEnvironment') {
					appParams.pcEnv = currParam[1];
				} else if(currParam[0] === 'pcConversationId') {
					appParams.pcConversationId = currParam[1];
				}
			}
		}
		
		return appParams;
	}
	</script>
	
    <script>
        var lifecycleStatusMessageTitle = 'Interaction App - Lifecycle Demo';
        var lifecycleStatusMessageId = 'lifecycleDemo-statusMsg';
        var blurCount = 0;

        $( document ).ready(function() {

			// Log Version and About using static properties
            console.log("Client App Version: " + window.purecloud.apps.ClientApp.version);
            console.log("Client App About: " + window.purecloud.apps.ClientApp.about());

			// Create instance of Client App SDK
            let myClientApp = new window.purecloud.apps.ClientApp();

			// Log the PureCloud environment (i.e. AWS Region)
            console.log("PureCloud Environment: " + myClientApp.pcEnvironment);

			// 
			// Bootstrap Listener
			//
            myClientApp.lifecycle.addBootstrapListener(() => {
                logLifecycleEvent('App Lifecycle Event: bootstrap', true);

                // Simulating bootstrap delay of 500ms
                window.setTimeout(() => {
                    myClientApp.lifecycle.bootstrapped();

                    myClientApp.alerting.showToastPopup(
                        lifecycleStatusMessageTitle,
                        'Bootstrap Complete (500ms delay)', {
                            id: lifecycleStatusMessageId,
                            type: 'success'
                        }
                    );

                    logLifecycleEvent('Notified PC of Successful App Bootstrap', false);
                }, 500);
            });

			//
			// Focus Listener
			//
            function onAppFocus () {
                logLifecycleEvent('App Lifecycle Event: focus', true);

                myClientApp.alerting.showToastPopup(
                    lifecycleStatusMessageTitle,
                    'App Focused', {
                        id: lifecycleStatusMessageId
                    }
                );
            }
            myClientApp.lifecycle.addFocusListener(onAppFocus);

			//
			// Blur Listener
			//
            function onAppBlur () {
                logLifecycleEvent('App Lifecycle Event: blur', true);

                myClientApp.alerting.showToastPopup(
                    lifecycleStatusMessageTitle,
                    'App Blurred', {
                        id: lifecycleStatusMessageId
                    }
                );

                myClientApp.alerting.setAttentionCount(++blurCount);
            }
            myClientApp.lifecycle.addBlurListener(onAppBlur);

			//
			// Stop Listener
			//
            myClientApp.lifecycle.addStopListener(() => {
                logLifecycleEvent('App Lifecycle Event: stop', true);

                // Clean up other, persistent listeners
                myClientApp.lifecycle.removeFocusListener(onAppFocus);
                myClientApp.lifecycle.removeBlurListener(onAppBlur);

                // Simulating delay of 500ms
                window.setTimeout(() => {
                    myClientApp.lifecycle.stopped();

                    myClientApp.alerting.showToastPopup(
                        lifecycleStatusMessageTitle,
                        'App Stopped (500ms delay)', {
                            id: lifecycleStatusMessageId,
                            type: 'error',
                            showCloseButton: true
                        }
                    );

                    logLifecycleEvent('Notified PC of Successful App Stop', false);
                }, 500);
            });

            function logLifecycleEvent(logText, incommingEvent) {
                console.log(logText)
            }
        });
    </script>
    
    <script src="//sdk-cdn.mypurecloud.com/javascript/58.0.0/purecloud-platform-client-v2.min.js"></script>
	<script>

        $( document ).ready(function() {

            // PureCloud OAuth information
            var platformClient = require('platformClient');
            var client = platformClient.ApiClient.instance;
            var clientId = 'b457d6c8-feb8-40f7-aff4-94d9cba953b5';
            var redirectUri = 'https://crespino4.github.io/gc_interactionapp/interactionapp.html';
            
            //var state = appParams.pcConversationId;
            const integrationQueryString = window.location.search.substring(1);
            
            // API instances
            var usersApi = new platformClient.UsersApi();
            var notificationsApi = new platformClient.NotificationsApi();
			var appParams = null;
			
			// Perform Implicit Grant Authentication
            client.loginImplicitGrant(clientId, redirectUri, { state: integrationQueryString })
                .then((data) => {
                	// User Authenticated
                	
                    console.log("Authenticated: " + JSON.stringify(data));
					appParams = parseAppParameters(data.state);
					document.querySelector("#conversation").innerHTML = "Conversation: " + appParams.pcConversationId;
					
                    // Make request to GET /api/v2/users/me?expand=presence
                    return usersApi.getUsersMe({ 'expand': ["presence","authorization"] });
                })
                .then((userMe) => {
                	// Me Response
                	
                    document.querySelector("#welcome").innerHTML = "Welcome " + userMe.name;

                    console.log(`Hello, ${userMe.name}!`);

                    // Create a Notifications Channel
                    return notificationsApi.postNotificationsChannels();
                }).then((channel) => {
                	// Channel Created
                	
                	// Setup WebSocket on Channel
                    var socket = new WebSocket(channel.connectUri);
                    socket.onmessage = onSocketMessage;

                    // Subscribe to conversation events in the queue.
                    let topic = [{"id": "v2.users.1c1ca8b5-8740-481e-92f5-cf23870284bd.conversations"}];
                    return notificationsApi.postNotificationsChannelSubscriptions(channel.id, topic);
                }).catch((err) => {
                    // Handle failure response
                    console.log(err);
                });

            // Handler for every Websocket message
            function onSocketMessage(event){
            	console.log("WebSocket Event Received: " + event.data);
                let data = JSON.parse(event.data);
                let topic = data.topicName;
                let eventBody = data.eventBody;

                console.log("Notification: Topic = " + topic);
                console.log("Notification: Body = " + eventBody);

				if ( topic == "v2.users.1c1ca8b5-8740-481e-92f5-cf23870284bd.conversations" ) {
	                // Do something here
	            }
            };
        });
    </script>    
</body>
</html>